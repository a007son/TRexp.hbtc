<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·®æ—…ç¶²å€ç”¢ç”Ÿå™¨ - Fluent Design</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ XLSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- è¨­å®š Tailwind çš„é¡è‰²è®Šæ•¸ä»¥ç¬¦åˆ Fluent UI -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        fluent: {
                            blue: '#0078D4',
                            hover: '#005A9E',
                            bg: '#f0f2f5',
                            excel: '#107C10' // æ–°å¢ Excel ç¶ è‰²
                        }
                    },
                    fontFamily: {
                        sans: ['"Segoe UI"', '"Microsoft JhengHei"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* æ‹–æ›³æ™‚çš„æ¨£å¼ */
        .dragging {
            opacity: 0.5;
            background-color: #f3f4f6;
            border: 2px dashed #0078D4;
        }
        
        /* Toggle Switch æ¨£å¼ä¿®æ­£ */
        .toggle-checkbox:checked {
            border-color: #0078D4;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #0078D4;
        }
    </style>
</head>
<body class="bg-fluent-bg text-neutral-900 min-h-screen font-sans py-8 px-4 flex justify-center">

    <div class="max-w-3xl w-full space-y-6">
        
        <!-- Header -->
        <div class="text-center space-y-2 mb-8">
            <div class="flex items-center justify-center gap-2 text-fluent-blue">
                <!-- Icon: Map -->
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon><line x1="8" y1="2" x2="8" y2="18"></line><line x1="16" y1="6" x2="16" y2="22"></line></svg>
                <h1 class="text-3xl font-bold tracking-tight text-neutral-800">å·®æ—…ç¶²å€ç”¢ç”Ÿå™¨</h1>
            </div>
            <div class="flex flex-col items-center gap-1">
                <p class="text-neutral-500 text-sm">å¯ç”¢ç”Ÿè¶…é10å€‹åœ°é»ä¹‹Google mapç¶²å€</p>
                <div class="flex gap-4 text-xs text-neutral-400 mt-1">
                    <span>âœ´ï¸ æœ€å¤š 24 å€‹åœ°é»</span>
					<span>ğŸ‘ æ¨è–¦ä½¿ç”¨ExcelåŒ¯å…¥åŠŸèƒ½</span>
                    <span>ğŸ”’ è³‡æ–™åƒ…åœ¨æœ¬æ©Ÿè™•ç†</span>
                </div>
            </div>
        </div>

        <!-- Main Card -->
        <div class="bg-white rounded-xl shadow-[0_2px_8px_rgba(0,0,0,0.08)] border border-neutral-200 overflow-hidden">
            
            <!-- Static Inputs -->
            <div class="p-6 pb-0 space-y-5">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                    <!-- èµ·é» -->
                    <div>
                        <label for="start-point" class="block text-sm font-semibold text-neutral-700 mb-1.5">èµ·é»</label>
                        <div class="relative">
                            <div class="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400">
                                <!-- Icon: Navigation -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg>
                            </div>
                            <input type="text" id="start-point" placeholder="ä¾‹å¦‚ï¼šè‡ºä¸­ç«è»Šç«™" oninput="syncEndPoint()" class="w-full pl-9 px-3 py-2 bg-white border border-neutral-300 rounded-md text-neutral-900 placeholder-neutral-400 focus:outline-none focus:border-fluent-blue focus:ring-1 focus:ring-fluent-blue transition-all duration-200">
                        </div>
                    </div>
                    <!-- çµ‚é» -->
                    <div>
                        <div class="flex justify-between items-center mb-1.5">
                            <label for="end-point" class="block text-sm font-semibold text-neutral-700">çµ‚é»</label>
                            
                            <!-- åŒèµ·é»é–‹é—œ -->
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-neutral-500">åŒèµ·é»</span>
                                <div class="relative inline-block w-8 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="toggle" id="round-trip-toggle" onclick="toggleRoundTrip()" class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer transition-transform duration-200 ease-in-out translate-x-0 checked:translate-x-full"/>
                                    <label for="round-trip-toggle" class="toggle-label block overflow-hidden h-4 rounded-full bg-neutral-300 cursor-pointer transition-colors duration-200 ease-in-out"></label>
                                </div>
                            </div>
                        </div>
                        <div class="relative">
                            <div class="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400">
                                <!-- Icon: MapPin -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                            </div>
                            <input type="text" id="end-point" placeholder="ä¾‹å¦‚ï¼šå°ä¸­å¸‚æ”¿åºœè¡›ç”Ÿå±€" class="w-full pl-9 px-3 py-2 bg-white border border-neutral-300 rounded-md text-neutral-900 placeholder-neutral-400 focus:outline-none focus:border-fluent-blue focus:ring-1 focus:ring-fluent-blue transition-all duration-200 disabled:bg-neutral-100 disabled:text-neutral-500">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs Navigation -->
            <div class="px-6 mt-6 border-b border-neutral-200">
                <div class="flex gap-6">
                    <button id="tab-excel-btn" onclick="switchTab('excel')" class="pb-3 px-1 text-sm font-semibold border-b-2 border-fluent-blue text-fluent-blue transition-colors duration-200 flex items-center gap-2">
                        <!-- Icon: FileSpreadsheet -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 22h14a2 2 0 0 0 2-2V7.5L14.5 2H6a2 2 0 0 0-2 2v4"/><path d="M14 2v6h6"/><path d="M8 15h2v2H8z"/><path d="M14 15h2v2h-2z"/><path d="M8 19h2v2H8z"/><path d="M14 19h2v2h-2z"/><path d="M3 8h10a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V9a1 1 0 0 1 1-1z"/></svg>
                        å¾ Excel åŒ¯å…¥
                    </button>
                    <button id="tab-manual-btn" onclick="switchTab('manual')" class="pb-3 px-1 text-sm font-semibold border-b-2 border-transparent text-neutral-500 hover:text-neutral-700 transition-colors duration-200 flex items-center gap-2">
                        <!-- Icon: Plus -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        æ‰‹å‹•è¼¸å…¥
                    </button>
                </div>
            </div>

            <!-- Tab Content -->
            <div class="p-6 bg-neutral-50/50 min-h-[200px]">
                
                <!-- Excel Tab -->
                <div id="tab-excel" class="space-y-5 fade-in">
                    
                    <div class="space-y-1.5">
                        <label class="block text-sm font-semibold text-neutral-700">1. ä¸Šå‚³æª”æ¡ˆ</label>
                        
                        <!-- ä¸Šå‚³å‰ç‹€æ…‹ (Upload Area) -->
                        <div id="upload-area" class="bg-white p-6 rounded-lg border-2 border-neutral-200 border-dashed hover:border-fluent-blue hover:bg-blue-50/30 transition-all cursor-pointer group relative">
                            <input type="file" id="excel-upload" accept=".xlsx, .xls, .csv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                            <div class="flex flex-col items-center justify-center gap-2 text-neutral-500 group-hover:text-fluent-blue">
                                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                                <span class="text-sm font-medium">é»æ“Šç€è¦½æˆ–æ‹–æ›³æª”æ¡ˆè‡³æ­¤</span>
                                <span class="text-xs text-neutral-400">æ”¯æ´ .xlsx, .xls, .csv</span>
                            </div>
                        </div>

                        <!-- ä¸Šå‚³å¾Œç‹€æ…‹ (File Artifact) -->
                        <div id="file-artifact" class="hidden bg-white p-3 rounded-md border border-neutral-200 shadow-sm flex items-center justify-between fade-in">
                            <div class="flex items-center gap-3 overflow-hidden">
                                <!-- Excel Icon -->
                                <div class="w-8 h-8 rounded bg-green-50 text-fluent-excel flex items-center justify-center shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 22h14a2 2 0 0 0 2-2V7.5L14.5 2H6a2 2 0 0 0-2 2v4"/><path d="M14 2v6h6"/><path d="M8 15h2v2H8z"/><path d="M14 15h2v2h-2z"/><path d="M8 19h2v2H8z"/><path d="M14 19h2v2h-2z"/></svg>
                                </div>
                                <div class="flex flex-col min-w-0">
                                    <span id="file-name-text" class="text-sm font-medium text-neutral-700 truncate">Filename.xlsx</span>
                                    <span class="text-xs text-green-600 flex items-center gap-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                        è®€å–æˆåŠŸ
                                    </span>
                                </div>
                            </div>
                            <button onclick="clearFile()" class="p-2 text-neutral-400 hover:text-red-600 hover:bg-red-50 rounded-md transition-colors" title="ç§»é™¤æª”æ¡ˆ">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                            </button>
                        </div>
                    </div>

                    <div id="column-selector-container" class="opacity-50 pointer-events-none transition-opacity duration-300">
                        <label for="col-select" class="block text-sm font-semibold text-neutral-700 mb-1.5">2. é¸æ“‡åœ°å€æ¬„ä½</label>
                        <select id="col-select" disabled class="w-full px-3 py-2 bg-white border border-neutral-300 rounded-md text-neutral-900 focus:outline-none focus:border-fluent-blue focus:ring-1 focus:ring-fluent-blue disabled:bg-neutral-100 disabled:text-neutral-400">
                            <option value="">-- è«‹å…ˆä¸Šå‚³æª”æ¡ˆ --</option>
                        </select>
                    </div>
                </div>

                <!-- Manual Tab (éš±è—) -->
                <div id="tab-manual" class="hidden space-y-3 fade-in">
                    <div id="manual-points-list" class="space-y-3">
                        <!-- JS æœƒåœ¨é€™è£¡å‹•æ…‹ç”¢ç”Ÿè¼¸å…¥æ¡† -->
                    </div>
                    
                    <button onclick="addManualPoint()" class="mt-2 text-sm text-fluent-blue font-medium hover:bg-blue-50 px-4 py-2 rounded-md transition-colors flex items-center gap-2 border border-transparent hover:border-blue-100">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        æ–°å¢ä¸­é€”é»
                    </button>
                    <p class="text-xs text-neutral-400 mt-2 ml-1">æç¤ºï¼šæŒ‰ä½å·¦å´å…­é»åœ–ç¤ºå¯ä¸Šä¸‹æ‹–æ›³æ’åº</p>
                </div>
            </div>

            <!-- Footer Action -->
            <div class="p-6 bg-white border-t border-neutral-100 flex flex-col items-center">
                <div id="error-msg" class="w-full mb-4 p-3 bg-red-50 border border-red-100 text-red-700 rounded-md text-sm flex items-center gap-2 hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                    <span id="error-text"></span>
                </div>
                
                <button onclick="generateLink()" class="w-full sm:w-auto min-w-[200px] bg-fluent-blue hover:bg-fluent-hover text-white font-semibold py-2.5 px-6 rounded-md shadow-sm active:scale-95 transition-all duration-150 flex items-center justify-center gap-2">
                    ç”¢ç”Ÿè·¯å¾‘ç¶²å€
                </button>
            </div>
        </div>

        <!-- Result Card -->
        <div id="result-card" class="bg-white rounded-xl shadow-[0_4px_12px_rgba(0,0,0,0.1)] border border-neutral-200 p-6 hidden fade-in">
            <h3 class="font-semibold text-lg mb-4 flex items-center gap-2 text-neutral-800">
                <svg class="text-green-600" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                ç”¢ç”ŸæˆåŠŸ
            </h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-neutral-700 mb-1.5">é è¦½ç¶²å€</label>
                    <div class="flex gap-2">
                        <input type="text" id="display-url" readonly class="flex-1 px-3 py-2 bg-neutral-50 border border-neutral-200 rounded-md text-neutral-600 text-sm font-mono truncate focus:outline-none select-all">
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row gap-3 pt-2">
                    <a id="open-link-btn" href="#" target="_blank" rel="noopener noreferrer" class="flex-1 inline-flex justify-center items-center gap-2 px-4 py-2 bg-fluent-blue text-white rounded-md font-medium hover:bg-fluent-hover transition-colors shadow-sm decoration-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                        åœ¨æ–°åˆ†é é–‹å•Ÿ
                    </a>
                    <button id="copy-btn" onclick="copyToClipboard()" class="flex-1 inline-flex justify-center items-center gap-2 px-4 py-2 border border-neutral-300 rounded-md font-medium bg-white text-neutral-700 hover:bg-neutral-50 transition-all duration-200">
                        <svg id="copy-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                        <span id="copy-text">è¤‡è£½ç¶²å€</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center text-neutral-400 text-sm py-4 font-medium">
            code with Gemini 3 PRO
        </div>
    </div>

    <script>
        // --- ç‹€æ…‹è®Šæ•¸ ---
        let currentTab = 'excel'; // é è¨­æ”¹ç‚º excel
        let manualPoints = [{ id: Date.now(), value: '' }];
        let excelData = [];
        let generatedUrlEncoded = '';
        let isRoundTrip = false;
        let dragStartIndex = -1;
        const MAX_LOCATIONS = 24;

        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            renderManualPoints();
        };

        // --- Tab åˆ‡æ›é‚è¼¯ ---
        function switchTab(tabName) {
            currentTab = tabName;
            
            const manualBtn = document.getElementById('tab-manual-btn');
            const excelBtn = document.getElementById('tab-excel-btn');
            const manualContent = document.getElementById('tab-manual');
            const excelContent = document.getElementById('tab-excel');

            const activeClass = "pb-3 px-1 text-sm font-semibold border-b-2 border-fluent-blue text-fluent-blue transition-colors duration-200 flex items-center gap-2";
            const inactiveClass = "pb-3 px-1 text-sm font-semibold border-b-2 border-transparent text-neutral-500 hover:text-neutral-700 transition-colors duration-200 flex items-center gap-2";

            if (tabName === 'manual') {
                manualBtn.className = activeClass;
                excelBtn.className = inactiveClass;
                manualContent.classList.remove('hidden');
                excelContent.classList.add('hidden');
            } else {
                excelBtn.className = activeClass;
                manualBtn.className = inactiveClass;
                excelContent.classList.remove('hidden');
                manualContent.classList.add('hidden');
            }
            hideError();
        }

        // --- åŒèµ·é» (ä¾†å›) é‚è¼¯ ---
        function toggleRoundTrip() {
            isRoundTrip = document.getElementById('round-trip-toggle').checked;
            const endInput = document.getElementById('end-point');
            const startInput = document.getElementById('start-point');
            
            if (isRoundTrip) {
                endInput.disabled = true;
                endInput.value = startInput.value;
                endInput.classList.add('bg-neutral-100');
            } else {
                endInput.disabled = false;
                endInput.classList.remove('bg-neutral-100');
                endInput.value = ''; // é—œé–‰æ™‚æ¸…ç©ºï¼Œæˆ–ä¿ç•™åŸå€¼è¦–éœ€æ±‚è€Œå®š
            }
        }

        function syncEndPoint() {
            if (isRoundTrip) {
                const startVal = document.getElementById('start-point').value;
                document.getElementById('end-point').value = startVal;
            }
        }

        // --- æ‰‹å‹•è¼¸å…¥ + æ‹–æ›³æ’åºé‚è¼¯ ---
        function renderManualPoints() {
            const container = document.getElementById('manual-points-list');
            container.innerHTML = '';
            
            manualPoints.forEach((point, index) => {
                const row = document.createElement('div');
                row.className = 'flex gap-2 items-center group fade-in';
                row.setAttribute('draggable', 'true');
                row.dataset.index = index;
                
                // æ‹–æ›³äº‹ä»¶ç¶å®š
                row.addEventListener('dragstart', handleDragStart);
                row.addEventListener('dragover', handleDragOver);
                row.addEventListener('drop', handleDrop);
                row.addEventListener('dragenter', handleDragEnter);
                row.addEventListener('dragleave', handleDragLeave);

                row.innerHTML = `
                    <!-- æ‹–æ›³æ‰‹æŠŠ (Grip) -->
                    <div class="cursor-move text-neutral-300 hover:text-neutral-500 p-1" title="æ‹–æ›³ä»¥æ’åº">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="12" r="1"></circle><circle cx="9" cy="5" r="1"></circle><circle cx="9" cy="19" r="1"></circle><circle cx="15" cy="12" r="1"></circle><circle cx="15" cy="5" r="1"></circle><circle cx="15" cy="19" r="1"></circle></svg>
                    </div>

                    <div class="w-6 h-6 rounded-full bg-neutral-200 text-neutral-500 flex items-center justify-center text-xs font-medium shrink-0 select-none">
                        ${index + 1}
                    </div>
                    <input 
                        type="text" 
                        value="${point.value}" 
                        oninput="updatePoint(${point.id}, this.value)"
                        placeholder="ä¸­é€”é» ${index + 1}"
                        class="w-full px-3 py-2 bg-white border border-neutral-300 rounded-md text-neutral-900 placeholder-neutral-400 focus:outline-none focus:border-fluent-blue focus:ring-1 focus:ring-fluent-blue transition-all duration-200"
                    >
                    <button 
                        onclick="removePoint(${point.id})"
                        class="p-2 text-neutral-400 hover:text-red-600 hover:bg-red-50 rounded-md transition-colors"
                        title="ç§»é™¤æ­¤åœ°é»"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    </button>
                `;
                container.appendChild(row);
            });
        }

        // --- Drag & Drop Handlers ---
        function handleDragStart(e) {
            dragStartIndex = +this.dataset.index;
            e.dataTransfer.effectAllowed = 'move';
            setTimeout(() => this.classList.add('opacity-50'), 0);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            this.classList.add('border-fluent-blue', 'border-dashed', 'bg-neutral-50');
        }

        function handleDragLeave(e) {
            this.classList.remove('border-fluent-blue', 'border-dashed', 'bg-neutral-50');
        }

        function handleDrop(e) {
            e.stopPropagation();
            
            const dragEndIndex = +this.dataset.index;
            
            if (dragStartIndex !== dragEndIndex) {
                const items = [...manualPoints];
                const [reorderedItem] = items.splice(dragStartIndex, 1);
                items.splice(dragEndIndex, 0, reorderedItem);
                manualPoints = items;
                renderManualPoints();
            } else {
                this.classList.remove('opacity-50');
                this.classList.remove('border-fluent-blue', 'border-dashed', 'bg-neutral-50');
                renderManualPoints();
            }
            
            return false;
        }

        function addManualPoint() {
            if (manualPoints.length + 2 >= MAX_LOCATIONS) {
                showError(`æœ€å¤šåªèƒ½è¨­å®š ${MAX_LOCATIONS} å€‹åœ°é»ï¼ˆå«èµ·é»/çµ‚é»ï¼‰ã€‚`);
                return;
            }
            manualPoints.push({ id: Date.now(), value: '' });
            renderManualPoints();
        }

        function removePoint(id) {
            manualPoints = manualPoints.filter(p => p.id !== id);
            renderManualPoints();
        }

        function updatePoint(id, value) {
            const point = manualPoints.find(p => p.id === id);
            if (point) point.value = value;
        }

        // --- Excel è™•ç†é‚è¼¯ ---
        document.getElementById('excel-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (json.length === 0) {
                        showError('Excel æª”æ¡ˆç‚ºç©ºæˆ–æ ¼å¼ä¸ç¬¦ï¼');
                        return;
                    }

                    // åˆ‡æ›ä»‹é¢ç‹€æ…‹ï¼šéš±è—ä¸Šå‚³å€ï¼Œé¡¯ç¤ºæª”æ¡ˆå¡ç‰‡
                    document.getElementById('upload-area').classList.add('hidden');
                    document.getElementById('file-artifact').classList.remove('hidden');
                    document.getElementById('file-name-text').textContent = file.name;
                    
                    // å•Ÿç”¨æ¬„ä½é¸æ“‡
                    const select = document.getElementById('col-select');
                    select.innerHTML = '<option value="">-- è«‹é¸æ“‡ --</option>';
                    select.disabled = false;
                    document.getElementById('column-selector-container').classList.remove('opacity-50', 'pointer-events-none');

                    const headers = json[0] || [];
                    headers.forEach((header, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        option.textContent = `ç¬¬ ${String.fromCharCode(65 + index)} æ¬„: ${header || '(ç©º)'}`;
                        select.appendChild(option);
                    });

                    // å„²å­˜è³‡æ–™
                    excelData = json.slice(1); 
                    hideError();

                } catch (error) {
                    console.error(error);
                    showError('è®€å–æª”æ¡ˆå¤±æ•—ï¼Œè«‹ç¢ºèªæ ¼å¼æ˜¯å¦æ­£ç¢º (.xlsx, .xls, .csv)');
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // --- æ¸…ç©º/åˆªé™¤æª”æ¡ˆ ---
        function clearFile() {
            // æ¸…ç©ºè³‡æ–™
            excelData = [];
            document.getElementById('excel-upload').value = '';
            
            // æ¢å¾©ä»‹é¢ç‹€æ…‹
            document.getElementById('upload-area').classList.remove('hidden');
            document.getElementById('file-artifact').classList.add('hidden');
            
            // é‡ç½®æ¬„ä½é¸æ“‡
            const select = document.getElementById('col-select');
            select.innerHTML = '<option value="">-- è«‹å…ˆä¸Šå‚³æª”æ¡ˆ --</option>';
            select.disabled = true;
            document.getElementById('column-selector-container').classList.add('opacity-50', 'pointer-events-none');
            
            hideError();
        }

        // --- æ ¸å¿ƒï¼šç”¢ç”Ÿç¶²å€ ---
        function generateLink() {
            hideError();
            const startPoint = document.getElementById('start-point').value.trim();
            const endPoint = document.getElementById('end-point').value.trim();

            if (!startPoint || !endPoint) {
                showError('æœªè¼¸å…¥èµ·è¨–åœ°é»ï¼Œè«‹ç¢ºèªå·²å¡«å¯«èµ·é»èˆ‡çµ‚é»ã€‚');
                return;
            }

            let midPoints = [];
            if (currentTab === 'manual') {
                midPoints = manualPoints.map(p => p.value.trim()).filter(v => v !== '');
            } else {
                const colIdx = document.getElementById('col-select').value;
                if (colIdx === '') {
                    showError('è«‹å…ˆé¸æ“‡åŒ…å«åœ°å€çš„ Excel æ¬„ä½');
                    return;
                }
                midPoints = excelData
                    .map(row => row[colIdx])
                    .filter(cell => cell != null && cell.toString().trim() !== '')
                    .map(cell => cell.toString().trim());
            }

            let allAddresses = [startPoint, ...midPoints, endPoint].filter(a => a);

            if (allAddresses.length < 2) {
                showError('è«‹è‡³å°‘æä¾›å…©å€‹æœ‰æ•ˆåœ°é»ï¼ˆèµ·é»/çµ‚é»æˆ–ä¸­é€”é»ï¼‰ã€‚');
                return;
            }

            if (allAddresses.length > MAX_LOCATIONS) {
                alert(`åœ°é»è¶…é ${MAX_LOCATIONS} å€‹ï¼Œå°‡åªå–å‰ ${MAX_LOCATIONS} å€‹åœ°é»ã€‚`);
                allAddresses = allAddresses.slice(0, MAX_LOCATIONS);
            }

            const baseUrl = 'https://www.google.com.tw/maps/dir/';
            generatedUrlEncoded = baseUrl + allAddresses.map(addr => encodeURIComponent(addr)).join('/');
            const displayUrl = baseUrl + allAddresses.join('/');

            // é¡¯ç¤ºçµæœ
            document.getElementById('result-card').classList.remove('hidden');
            document.getElementById('display-url').value = displayUrl;
            document.getElementById('open-link-btn').href = generatedUrlEncoded;
            
            // é‡ç½®è¤‡è£½æŒ‰éˆ•
            const copyBtn = document.getElementById('copy-btn');
            const copyText = document.getElementById('copy-text');
            copyBtn.className = "flex-1 inline-flex justify-center items-center gap-2 px-4 py-2 border border-neutral-300 rounded-md font-medium bg-white text-neutral-700 hover:bg-neutral-50 transition-all duration-200";
            copyText.textContent = "è¤‡è£½ç¶²å€";
        }

        // --- è¤‡è£½åŠŸèƒ½ ---
        async function copyToClipboard() {
            if (!generatedUrlEncoded) return;
            try {
                await navigator.clipboard.writeText(generatedUrlEncoded);
                
                const copyBtn = document.getElementById('copy-btn');
                const copyText = document.getElementById('copy-text');
                
                // åˆ‡æ›æˆæˆåŠŸæ¨£å¼
                copyBtn.className = "flex-1 inline-flex justify-center items-center gap-2 px-4 py-2 border border-green-200 bg-green-50 text-green-700 rounded-md font-medium transition-all duration-200";
                copyText.textContent = "å·²è¤‡è£½ï¼";
                
                setTimeout(() => {
                    copyBtn.className = "flex-1 inline-flex justify-center items-center gap-2 px-4 py-2 border border-neutral-300 rounded-md font-medium bg-white text-neutral-700 hover:bg-neutral-50 transition-all duration-200";
                    copyText.textContent = "è¤‡è£½ç¶²å€";
                }, 2000);
            } catch (err) {
                showError('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–è¤‡è£½ã€‚');
            }
        }

        // --- éŒ¯èª¤è™•ç†è¼”åŠ© ---
        function showError(msg) {
            const el = document.getElementById('error-msg');
            const text = document.getElementById('error-text');
            text.textContent = msg;
            el.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('error-msg').classList.add('hidden');
        }

    </script>
</body>
</html>
